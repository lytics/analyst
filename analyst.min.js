(function(){function e(e){var t={};e.on=function(n,r,i){var o,u,a,f;if(!r)return e;n=n.split(s);while(o=n.shift())f=t[o],u=f?f.tail:{},u.next=a={},u.context=i,u.callback=r,t[o]={tail:a,next:f?f.next:u};return e},e.off=function(n,r,i){var o,u,a,f,l;if(!(n||r||i))return t={},e;n=n?n.split(s):_.keys(t);while(o=n.shift()){u=t[o],delete t[o];if(!u||!r&&!i)continue;a=u.tail;while((u=u.next)!==a)f=u.callback,l=u.context,(r&&f!==r||i&&l!==i)&&e.on(o,f,l)}return e},e.trigger=function(n){var r,i,o,u,a,f;a=t.all,n=n.split(s),f=[].slice.call(arguments,1);while(r=n.shift()){if(i=t[r]){o=i.tail;while((i=i.next)!==o)i.callback.apply(i.context||e,f)}if(i=a){o=i.tail,u=[r].concat(f);while((i=i.next)!==o)i.callback.apply(i.context||e,u)}}return e}}var t=this,n=t.d3,r=t.crossfilter,i={version:"0.1.0"};(function(){"use strict";function s(e){return e.charAt(0).toUpperCase()+e.slice(1)}function o(e){var t=s(e);return function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}}function u(){return 0}function a(){return{}}function f(e,t){return(e?e+".":"")+t}function l(e,t){return v(t)?function(n){return t(n,e)}:function(n){var r=e(t);return r!==null?n[r]:null}}function c(e){return function(t){return t[e]}}var h={};i.addDriver=function(e,t){h[e]=t},i.source=function(i){function o(e){var t=g.fieldMap();return t&&e in t?t[e]:null}function m(e){if(!E[e]){var t=w.dimension(l(o,e)),n=t.filter;t.filter=function(e){return n.call(t,e),t._value=e,g.trigger("filter",t,e),t},t._value=null,E[e]=t}return E[e]}if(!h[i])throw new Error("Source type '"+i+"' unknown");var g={},y=[],b={},w=r(),E={},S=h[i].apply(g,p(arguments,1)),x;return e(g),g.filter=function(e){return y.push(l(o,e)),g},g.add=function(e){var t=!w.size();w.add(y.reduce(function(e,t){return e.filter(t)},e)),t&&g.trigger("ready"),g.trigger("change")},g.fieldMap=function(e){return arguments.length?(b=e,g):b},g.fetch=function(){return S(),g},g.start=function(e){return g.stop(),x=t.setTimeout(function n(){g.fetch(function(){t.setTimeout(n,e)})},e),g},g.stop=function(){return x&&(x=t.clearTimeout(x)),g},g.metric=function(){function t(e){var t=d(k);return t.length?t.reduce(function(t,n){return t[k[n]]=e[n],t},{}):e}function r(e){var t=d(k),n=A.reduce(function(e,t){return t(e)},e);return t.length===1?n[t[0]]:n}function i(e){return function(t,n){return L.reduce(function(t,r){return t[r.field]=r[e](t[r.field],n),t},t||{})}}function h(e,t){return function(n){var r=p(arguments,1),i=f(n,t),s=v(r[0])?i:r.shift()||i;return k[i]=s,r.forEach(function(e){A.push(function(t){return t[s]=e(t[s]),t})}),e(n,i)}}function y(){return T.reduce(function(e){return e+1},function(e){return e-1},u,"count")}function b(e,t){var n=l(o,e);return T.reduce(function(e,t){return e+n(t)},function(e,t){return e-n(t)},u,t)}function E(e,t){var n=f(e,"total");return t in D()||(y(),b(e,n),A.unshift(function(e){return e[t]=e.count?e[n]/e.count:0,e})),T}function S(e,t){var n=l(o,e);return T.reduce(function(e,t){var r=n(t);return r in e?e[r]++:e[r]=1,e},function(e,t){var r=n(t);return r in e&&(e[r]--,e[r]||delete e[r]),e},a,t)}function x(e,t){var n=l(o,e),r=f(e,"distincts");return t in D()||(S(e,r),A.unshift(function(e){return e[t]=d(e[r]).length,e})),T}var T={},N,C,k={},L=[],A=[t],O=l(o,"_date"),M=i("add"),_=i("remove"),D=i("initial");return e(T),T.by=function(e){if(N)throw new Error("A metric can only be dimensioned once");return N=m(e),T},["hour","day","week","month"].forEach(function(e){var t="by"+s(e);T[t]=function(){return T.by(function(t){return n.time[e](O(t))})}}),T.byDate=function(e){return T.by(function(t){return e?e(O(t)):O(t)})},T.byDateFormat=function(e){var t=n.time.format(e);return T.by(function(e){return t(O(e))})},T.byDayOfWeek=function(e,t){return e=e===undefined||e,e?T.byDateFormat(t?"%a":"%A"):function(e){return O(e).getDay()}},T.byHourOfDay=function(){return T.by(function(e){return O(e).getHours()})},T.reduce=function(e,t,n,r){return r=r||"output",r in D()||L.push({add:e,remove:t,initial:n,field:r}),T},T.count=h(y),T.sum=h(b,"total"),T.average=h(E,"average"),T.distinct=h(S,"distincts"),T.distinctCount=h(x,"distinct_total"),T.dimension=function(){return N},T.filter=function(e){if(!N)throw new Error("A metric can only be filtered after being dimensioned");return e===undefined?N._value:N.filter.call(N,e)},T.group=function(){if(!C){C=N?N.group():w.groupAll(),L.length&&C.reduce(M,_,D);if(C.all){var e=C.all;C.all=function(){return e.call(C).map(function(e){return{key:e.key,value:r(e.value)}})}}else{var t=C.value;C.value=function(){return r(t.call(C))}}}return C},T.value=function(){var e=T.group();return e[e.value?"value":"all"]()},T.domain=function(){return N?T.group().all().map(c("key")):null},T.extract=function(e){return A.push(c(e)),T},T.transform=function(e){var t=p(arguments);return A=A.concat(t),T},["ready","change","filter"].forEach(function(e){g.on(e,function(){var t=[e].concat(p(arguments));T.trigger.apply(T,t)})}),g.on("filter",function(e,t){(!N||e!==N)&&T.trigger("change")}),T},g};var p=Function.prototype.call.bind(Array.prototype.slice),d=Object.keys,v=o("function"),m=o("object"),g=Array.isArray})();var s=/\s+/;i.addDriver("lytics",function(e){var n=this;return e=e||{},function(r){var i=e.url||"//api.lytics.io",s=i+"/api/"+(e.clientId?e.clientId+"/":"")+e.query,o=e.data||{},u=[],a=document.createElement("script"),f="analyst_lytics_"+(new Date).getTime();u.push("callback="+f),Object.keys(o).forEach(function(e){u.push(e+"="+o[e])}),u.length&&(s+="?"+u.join("&"));var l=function(e){var r=[];if(e.meta){var i=e.meta.dimensions,s=e.meta.measures,o={};offset=1,i&&i.length>0?(i.forEach(function(e,t){o[e]=t}),offset=i.length):o._=0,s.forEach(function(e,t){o[e.As]=t+offset}),o._ts=offset+s.length,o._date=o._ts+1,n.fieldMap(o)}e.data&&e.data.forEach(function(e){var t=e._ts,n=new Date(t.ts*1e3);e.rows.forEach(function(e,i){e.push(t.ts),e.push(n),r.push(e)})}),n.add(r),delete t[f],a.remove()};a.src=s,t[f]=l,document.body.appendChild(a)}}),typeof exports!="undefined"?exports.analyst=i:typeof define=="function"&&define.amd?define("analyst",function(){return i}):t.analyst=i})();