(function(){function e(e,t){return e.indexOf(t)!==-1}function t(e,t){return P(t)?(O(t).forEach(function(n){e[n]=t[n]}),e):t}function n(e){return t({},e)}function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}function i(e){var t=r(e);return function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}}function s(e){var t,n;for(var r=0,i=e.length;r<i;r++)(t=+e[r])!=null&&(n==null||t>n)&&(n=t);return n}function o(){var e=L(arguments),t=e.pop();return name=e.map(function(e){return D(e)?e.name||B++:e}).join("_"),(name?name+".":"")+t}function u(e,t){if(D(e))return t?e.bind(t):e;if(!t)return function(t){return t[e]||null};var n=function(t){return t[this.indexFor?this.indexFor(e):e]||null};n=n.bind(t);if(M(e)&&e[0]==="/"){var r=e.match(/\/(\w+)(.*)/),i=r[2]||"/";return e=r[1],function(e){var t=n(e);return P(t)?C.jsonpointer.get(t,i):t}}return n}function a(e){return function(){return e}}function f(e){return function(t){return-(e?e(t):t)}}function l(e){return function(t,n){return t+ +(e?e(n):n)}}function c(){return{}}function h(){return[]}function p(){return 0}function d(){return{add:j,remove:F,initial:p}}function v(e){return{add:l(e),remove:l(f(e)),initial:p}}function m(e,t){return{add:function(n,r){var i=e(r);return P(i)&&O(i).forEach(function(e){e in n||(n[e]=t.initial()),n[e]=t.add.call(this,n[e],i[e])}),n},remove:function(n,r){var i=e(r);return P(i)&&O(i).forEach(function(e){e in n&&(n[e]=t.remove.call(this,n[e],i[e]),n[e]||delete n[e])}),n},initial:c}}function g(e,t){var n=b(u("key"));return{add:function(r,i){var s=e(i);return H(s)&&s.forEach(function(e){var i=n(r,e.key);i===-1&&(i=r.length,r.push({key:e.key,value:t.initial()})),r[i].value=t.add.call(this,r[i].value,e.value)}),r},remove:function(r,i){var s=e(i);return H(s)&&s.forEach(function(e){var i=n(r,e.key);i!==-1&&(r[i].value=t.remove.call(this,r[i].value,e.value),r[i].value||r.splice(i,1))}),r},initial:h}}function y(e){return{add:function(t,n){var r=e(n);return r in t||(t[r]=0),t[r]++,t},remove:function(t,n){var r=e(n);return r in t&&(t[r]--,t[r]||delete t[r]),t},initial:c}}function b(e){return D(e)?function(n,r){var i=-1;return n.every(function(t,n){return r===e(t)?(i=n,!1):!0}),i}:Function.prototype.call.bind(Array.prototype.indexOf)}function w(e){D(e)||(e=u(e));var t=N.quicksort.by(e);return function(e){return H(e)?t(L(e),0,e.length):e}}function E(e){return function(t){return!H(t)||t.length<=e?t:L(t,0,e)}}function S(e){var t={};e.on=function(n,r,i){var s,o,u,a;if(!r)return e;n=n.split(I);while(s=n.shift())a=t[s],o=a?a.tail:{},o.next=u={},o.context=i,o.callback=r,t[s]={tail:u,next:a?a.next:o};return e},e.off=function(n,r,i){var s,o,u,a,f;if(!(n||r||i))return t={},e;n=n?n.split(I):_.keys(t);while(s=n.shift()){o=t[s],delete t[s];if(!o||!r&&!i)continue;u=o.tail;while((o=o.next)!==u)a=o.callback,f=o.context,(r&&a!==r||i&&f!==i)&&e.on(s,a,f)}return e},e.trigger=function(n){var r,i,s,o,u,a;u=t.all,n=n.split(I),a=[].slice.call(arguments,1);while(r=n.shift()){if(i=t[r]){s=i.tail;while((i=i.next)!==s)i.callback.apply(i.context||e,a)}if(i=u){s=i.tail,o=[r].concat(a);while((i=i.next)!==s)i.callback.apply(i.context||e,o)}}return e}}var x=this,T=x.d3,N=x.crossfilter,C={version:"0.1.3"},k={};C.addDriver=function(e,t){if(C[e])throw new Error("Attempting to add a driver that already exists or is protected: '"+e+"'");return k[e]=t,C[e]=function(){var t=[e].concat(L(arguments));return C.source.apply(C,t)},C};var L=Function.prototype.call.bind(Array.prototype.slice),A=Function.prototype.call.bind(Array.prototype.reverse),O=Object.keys,M=i("string"),D=i("function"),P=i("object"),H=Array.isArray,B=1,j=l(a(1)),F=l(a(-1)),I=/\s+/;C.jsonpointer=function(){var e=function(e){return e.replace(/~./g,function(e){switch(e){case"~0":return"~";case"~1":return"/"}throw"Invalid tilde escape: "+e})},t=function(n,r,i){var s=e(r.shift());if(!n.hasOwnProperty(s))return null;if(r.length!==0)return t(n[s],r,i);if(typeof i=="undefined")return n[s];var o=n[s];return i===null?delete n[s]:n[s]=i,o},n=function(e,t){if(typeof e!="object")throw"Invalid input object.";if(t==="")return[];if(!t)throw"Invalid JSON pointer.";t=t.split("/");var n=t.shift();if(n!=="")throw"Invalid JSON pointer.";return t},r=function(e,r){return r=n(e,r),r.length===0?e:t(e,r)};return{get:r}}(),C.source=function(e){if(!k[e])throw new Error("Source type '"+e+"' unknown");var t={},n=[],r,i={},s=N(),o={},a,f;return S(t),t.add=function(e){if(!H(e))throw new Error("Input data must be an array");var n=!s.size(),i;return r&&(e=e.reduce(function(e,n){return(i=r.call(t,n))&&e.push(i),e},[])),s.add(e),n&&t.trigger("ready"),t.trigger("change"),t},t.sanitizer=function(e){if(!arguments.length)return r;if(!D(e))throw new Error("Sanitizer must be a function");return r=e,t},t.fieldMap=function(e){if(!arguments.length)return i;if(!P(e))throw new Error("Field map must be a plain object");return i=e,t},t.indexFor=function(e){return e in i?i[e]:null},t.fetch=function(){return D(a)&&a(),t},t.start=function(e){return t.stop(),f=x.setTimeout(function n(){t.fetch(function(){x.setTimeout(n,e)})},e),t},t.stop=function(){return f&&(f=x.clearTimeout(f)),t},t.metric=function(){return C.metric(t)},t.crossfilter=function(){return s},t.dimension=function(e){if(!o[e]){var n=u(e,t),r=s.dimension(n),i=r.filter;r.filter=function(e){return i.call(r,e),r._value=e,t.trigger("filter",r,e),r},r._value=null,o[e]=r}return o[e]},a=k[e].apply(t,L(arguments,1)),t},C.metric=function(t){function i(t){var n=L(U);return e(q,"_")?n.push(u("_")):D(z)||n.push(function(e){return q.reduce(function(t,n){return t[n]=e[n],t},{})}),n.reduce(function(e,t){return t(e)},t)}function a(e){return function(n,r){return n=n||{},O(R).forEach(function(i){n[i]=R[i][e].call(t,n[i],r)}),n}}function f(e,t){return function(n){return n[t]=n[e],n}}function l(t){return function(){var n=arguments,r=t.length,i=L(n,r),s=M(i[0])?i.shift():"_",o;if(e(q,"_"))throw new Error("All reducing functions must be aliased");if(e(q,s))throw new Error("Reduce function alias already exists: '"+s+"'");return q.push(s),o=t.apply(j,L(n,0,r)),U.push(f(o,s)),i.length&&j.transform(s,i),j}}function c(e,t,n){var r=q.length;return R[r]={add:e,remove:t,initial:n},r}function h(){var e="count";return R[e]=d(),e}function p(e){var n=o(e,"total"),r=u(e,t);return R[n]=v(r),n}function b(e){return x(e,null)}function x(e,t){var n=o(e,t,"average");return e=p(e),t=t?p(t):h(),U.push(function(r){return r[n]=r[t]?r[e]/r[t]:0,r}),n}function N(e){var n=o(e,"distincts"),r=u(e,t);return R[n]=y(r),n}function C(e){var t=o(e,"distinct_count"),n=N(e);return U.push(function(e){return e[t]=O(e[n]).length,e}),t}function k(e){var t=o(e,"max"),n=N(e);return U.push(function(e){return e[t]=s(O(e[n])),e}),t}function _(e){var n=o(e,"sum_object"),r=u(e,t);return R[n]=m(r,v()),n}function P(e){var n=o(e,"sum_array"),r=u(e,t);return R[n]=g(r,v()),n}function B(e){return function(t){var n=L(arguments);return n.length<=e.length?t="_":n.shift(),transform=e.apply(j,n),j.transform(t,transform)}}var j={},F,I,q=[],R={},U=[n],z=null,W=u("_date",t);return S(j),j.by=function(e){if(F)throw new Error("A metric can only be dimensioned once");return F=t.dimension(e),j},["hour","day","week","month"].forEach(function(e){var t="by"+r(e);j[t]=function(){return j.by(function(t){return T.time[e](W(t))})}}),j.byDate=function(e){return j.by(function(t){return e?e(W(t)):W(t)})},j.byDateFormat=function(e){var t=T.time.format(e);return j.by(function(e){return t(W(e))})},j.byDayOfWeek=function(e,t){return e=e===undefined||e,e?j.byDateFormat(t?"%a":"%A"):function(e){return W(e).getDay()}},j.byHourOfDay=function(){return j.by(function(e){return W(e).getHours()})},j.reduce=l(c),j.count=l(h),j.sum=l(p),j.average=l(b),j.weightedAverage=l(x),j.distinct=l(N),j.distinctCount=l(C),j.max=l(k),j.sumObject=l(_),j.sumArray=l(P),j.dimension=function(){return F},j.filter=function(e){return F?e===undefined?F._value:F.filter.call(F,e):e===undefined?j:null},j.group=function(){if(!I){I=F?F.group():t.crossfilter().groupAll(),q.length&&I.reduce(a("add"),a("remove"),a("initial"));if(I.all){var e=I.all;I.all=function(){return e.call(I).map(function(e){return{key:e.key,value:i(e.value)}})}}else{var n=I.value;I.value=function(){return i(n.call(I))}}}return I},j.value=function(){var e=j.group();return e[e.value?"value":"all"]()},j.domain=function(){return F?j.group().all().map(u("key")):null},j.transform=function(t){var n=L(arguments);if(M(t)){if(!e(q,t))throw new Error("The specified reduce funciton alias has not been defined");n.shift()}else if(!D(z)){if(!e(q,"_"))throw new Error("An alias must be supplied for the transform to be applied to");t="_"}return n=H(n[0])?n[0]:n,D(z)?U=U.concat(n):n.forEach(function(e){U.push(function(n){return n[t]=e(n[t]),n})}),j},j.combine=function(t){if(e(q,"_"))throw new Error("All reduce functions must be aliased to transform all values");if(D(z))throw new Error("Only one combining function can be specified");return U.push(z=t),j},j.extract=function(e){return j.combine(u(e))},j.limit=B(E),j.order=j.orderAsc=B(w),j.orderDesc=B(function(e){var t=w(e);return function(e){return A(t(e))}}),j.reverse=B(function(){return function(e){return A(L(e))}}),["ready","change","filter"].forEach(function(e){t.on(e,function(){var t=[e].concat(L(arguments));j.trigger.apply(j,t)})}),t.on("filter",function(e,t){(!F||e!==F)&&j.trigger("change")}),j},C.addDriver("preload",function(e,t){P(t)&&this.fieldMap(t),this.add(H(e)?e:[])}),C.addDriver("lytics",function(e){function t(e,t){var n=e.url||"//api.lytics.io",r=n+"/api/"+(e.clientId?e.clientId+"/":"")+e.query,i=e.data||{},s=[];return Object.keys(i).forEach(function(e){s.push(e+"="+i[e])}),s.length&&(r+="?"+s.join("&")),r}function n(e){e.meta&&e.data&&i(e.data,r(e.meta))}function r(e){var t=e.dimensions,n=e.measures,r={},i={},u=1;return t&&t.length>0?(t.forEach(function(e,t){i[e]=t}),u=t.length):i._=0,n.forEach(function(e,t){i[e.As]=t+u,e.Op==="top"&&(r[t+u]=s)}),i._ts=u+n.length,i._date=i._ts+1,o.fieldMap(i),r}function i(e,t){var n=[];e.forEach(function(e){var r=e._ts,i=new Date(r.ts*1e3);e.rows.forEach(function(e,s){Object.keys(t).forEach(function(n){e[n]=t[n](e[n])}),e.push(r.ts),e.push(i),n.push(e)})}),o.add(n)}function s(e){return Array.isArray(e)?e.map(function(e){return key=Object.keys(e)[0],{key:key,value:e[key]}}):e}var o=this;return e=e||{},function(r){var i=document.createElement("script"),s="analyst_lytics_"+C.lytics.nonce++;e.data=e.data||{},e.data.callback=s,x[s]=function(e){n(e),delete x[s],i.remove()},i.src=t(e,r),document.body.appendChild(i)}}),C.lytics.nonce=(new Date).getTime(),typeof module!="undefined"?module.exports=C:typeof define=="function"&&define.amd?define("analyst",function(){return C}):x.analyst=C})();