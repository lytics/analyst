(function(){function e(e,t){return e.indexOf(t)!==-1}function t(e,t){return D(t)?(A(t).forEach(function(n){e[n]=t[n]}),e):t}function n(e){return t({},e)}function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}function i(e){var t=r(e);return function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}}function s(e,t){return(e?e+".":"")+t}function o(e,t){if(!t)return function(t){return t[e]||null};var n=function(t){return t[this.indexFor?this.indexFor(e):e]||null};n=n.bind(t);if(O(e)&&e[0]==="/"){var r=e.match(/\/(\w+)(.*)/),i=r[2]||"/";return e=r[1],function(e){var t=n(e);return D(t)?N.jsonpointer.get(t,i):t}}return n}function u(e){return function(){return e}}function a(e){return function(t){return-(e?e(t):t)}}function f(e){return function(t,n){return t+ +(e?e(n):n)}}function l(){return{}}function c(){return[]}function h(){return 0}function p(){return{add:H,remove:B,initial:h}}function d(e){return{add:f(e),remove:f(a(e)),initial:h}}function v(e,t){return{add:function(n,r){var i=e(r);return A(i).forEach(function(e){e in n||(n[e]=t.initial()),n[e]=t.add.call(this,n[e],i[e])}),n},remove:function(n,r){var i=e(r);return A(i).forEach(function(e){e in n&&(n[e]=t.remove.call(this,n[e],i[e]),n[e]||delete n[e])}),n},initial:l}}function m(e,t){var n=y(o("key"));return{add:function(r,i){var s=e(i);return s.forEach(function(e){var i=n(r,e.key);i===-1&&(i=r.length,r.push({key:e.key,value:t.initial()})),r[i].value=t.add.call(this,r[i].value,e.value)}),r},remove:function(r,i){var s=e(i);return s.forEach(function(e){var i=n(r,e.key);i!==-1&&(r[i].value=t.remove.call(this,r[i].value,e.value),r[i].value||r.splice(i,1))}),r},initial:c}}function g(e){return{add:function(t,n){var r=e(n);return r in t||(t[r]=0),t[r]++,t},remove:function(t,n){var r=e(n);return r in t&&(t[r]--,t[r]||delete t[r]),t},initial:l}}function y(e){return M(e)?function(n,r){var i=-1;return n.every(function(t,n){return r===e(t)?(i=n,!1):!0}),i}:Function.prototype.call.bind(Array.prototype.indexOf)}function b(e){M(e)||(e=o(e));var t=T.quicksort.by(e);return function(e){return P(e)?t(k(e),0,e.length):e}}function w(e){return function(t){return!P(t)||t.length<=e?t:k(t,0,e)}}function E(e){var t={};e.on=function(n,r,i){var s,o,u,a;if(!r)return e;n=n.split(j);while(s=n.shift())a=t[s],o=a?a.tail:{},o.next=u={},o.context=i,o.callback=r,t[s]={tail:u,next:a?a.next:o};return e},e.off=function(n,r,i){var s,o,u,a,f;if(!(n||r||i))return t={},e;n=n?n.split(j):_.keys(t);while(s=n.shift()){o=t[s],delete t[s];if(!o||!r&&!i)continue;u=o.tail;while((o=o.next)!==u)a=o.callback,f=o.context,(r&&a!==r||i&&f!==i)&&e.on(s,a,f)}return e},e.trigger=function(n){var r,i,s,o,u,a;u=t.all,n=n.split(j),a=[].slice.call(arguments,1);while(r=n.shift()){if(i=t[r]){s=i.tail;while((i=i.next)!==s)i.callback.apply(i.context||e,a)}if(i=u){s=i.tail,o=[r].concat(a);while((i=i.next)!==s)i.callback.apply(i.context||e,o)}}return e}}var S=this,x=S.d3,T=S.crossfilter,N={version:"0.1.1"},C={};N.addDriver=function(e,t){if(N[e])throw new Error("Attempting to add a driver that already exists or is protected: '"+e+"'");return C[e]=t,N[e]=function(){var t=[e].concat(k(arguments));return N.source.apply(N,t)},N};var k=Function.prototype.call.bind(Array.prototype.slice),L=Function.prototype.call.bind(Array.prototype.reverse),A=Object.keys,O=i("string"),M=i("function"),D=i("object"),P=Array.isArray,H=f(u(1)),B=f(u(-1)),j=/\s+/;N.jsonpointer=function(){var e=function(e){return e.replace(/~./g,function(e){switch(e){case"~0":return"~";case"~1":return"/"}throw"Invalid tilde escape: "+e})},t=function(n,r,i){var s=e(r.shift());if(!n.hasOwnProperty(s))return null;if(r.length!==0)return t(n[s],r,i);if(typeof i=="undefined")return n[s];var o=n[s];return i===null?delete n[s]:n[s]=i,o},n=function(e,t){if(typeof e!="object")throw"Invalid input object.";if(t==="")return[];if(!t)throw"Invalid JSON pointer.";t=t.split("/");var n=t.shift();if(n!=="")throw"Invalid JSON pointer.";return t},r=function(e,r){return r=n(e,r),r.length===0?e:t(e,r)};return{get:r}}(),N.source=function(e){if(!C[e])throw new Error("Source type '"+e+"' unknown");var t={},n=[],r,i={},s=T(),u={},a,f;return E(t),t.add=function(e){if(!P(e))throw new Error("Input data must be an array");var n=!s.size(),i;return r&&(e=e.reduce(function(e,n){return(i=r.call(t,n))&&e.push(i),e},[])),s.add(e),n&&t.trigger("ready"),t.trigger("change"),t},t.sanitizer=function(e){if(!arguments.length)return r;if(!M(e))throw new Error("Sanitizer must be a function");return r=e,t},t.fieldMap=function(e){if(!arguments.length)return i;if(!D(e))throw new Error("Field map must be a plain object");return i=e,t},t.indexFor=function(e){return e in i?i[e]:null},t.fetch=function(){return M(a)&&a(),t},t.start=function(e){return t.stop(),f=S.setTimeout(function n(){t.fetch(function(){S.setTimeout(n,e)})},e),t},t.stop=function(){return f&&(f=S.clearTimeout(f)),t},t.metric=function(){return N.metric(t)},t.crossfilter=function(){return s},t.dimension=function(e){if(!u[e]){var n=M(e)?e.bind(t):o(e,t),r=s.dimension(n),i=r.filter;r.filter=function(e){return i.call(r,e),r._value=e,t.trigger("filter",r,e),r},r._value=null,u[e]=r}return u[e]},a=C[e].apply(t,k(arguments,1)),t},N.metric=function(t){function i(t){var n=k(F);return e(B,"_")?n.push(o("_")):n.push(function(e){return B.reduce(function(t,n){return t[n]=e[n],t},{})}),n.reduce(function(e,t){return t(e)},t)}function u(e){return function(n,r){return n=n||{},A(j).forEach(function(i){n[i]=j[i][e].call(t,n[i],r)}),n}}function a(e,t){return function(n){return n[t]=n[e],n}}function f(t){return function(){var n=arguments,r=t.length,i=k(n,r),s=O(i[0])?i.shift():"_",o;if(e(B,"_"))throw new Error("All reducing functions must be aliased");if(e(B,s))throw new Error("Reduce function alias already exists: '"+s+"'");return B.push(s),o=t.apply(_,k(n,0,r)),F.push(a(o,s)),i.length&&_.transform(s,i),_}}function l(e,t,n){var r=B.length;return j[r]={add:e,remove:t,initial:n},r}function c(){var e="count";return j[e]=p(),e}function h(e){var n=s(e,"total"),r=o(e,t);return j[n]=d(r),n}function y(e){var t=s(e,"average"),n=c(),r=h(e);return F.push(function(e){return e[t]=e[n]?e[r]/e[n]:0,e}),t}function S(e){var n=s(e,"distincts"),r=o(e,t);return j[n]=g(r),n}function T(e){var t=s(e,"distinct_count"),n=S(e);return F.push(function(e){return e[t]=A(e[n]).length,e}),t}function N(e){var n=s(e,"sum_object"),r=o(e,t);return j[n]=v(r,d()),n}function C(e){var n=s(e,"sum_array"),r=o(e,t);return j[n]=m(r,d()),n}function M(e){return function(t){var n=k(arguments);return n.length<=e.length?t="_":n.shift(),transform=e.apply(_,n),_.transform(t,transform)}}var _={},D,H,B=[],j={},F=[n],I=o("_date",t);return E(_),_.by=function(e){if(D)throw new Error("A metric can only be dimensioned once");return D=t.dimension(e),_},["hour","day","week","month"].forEach(function(e){var t="by"+r(e);_[t]=function(){return _.by(function(t){return x.time[e](I(t))})}}),_.byDate=function(e){return _.by(function(t){return e?e(I(t)):I(t)})},_.byDateFormat=function(e){var t=x.time.format(e);return _.by(function(e){return t(I(e))})},_.byDayOfWeek=function(e,t){return e=e===undefined||e,e?_.byDateFormat(t?"%a":"%A"):function(e){return I(e).getDay()}},_.byHourOfDay=function(){return _.by(function(e){return I(e).getHours()})},_.reduce=f(l),_.count=f(c),_.sum=f(h),_.average=f(y),_.distinct=f(S),_.distinctCount=f(T),_.sumObject=f(N),_.sumArray=f(C),_.dimension=function(){return D},_.filter=function(e){return D?e===undefined?D._value:D.filter.call(D,e):e===undefined?_:null},_.group=function(){if(!H){H=D?D.group():t.crossfilter().groupAll(),B.length&&H.reduce(u("add"),u("remove"),u("initial"));if(H.all){var e=H.all;H.all=function(){return e.call(H).map(function(e){return{key:e.key,value:i(e.value)}})}}else{var n=H.value;H.value=function(){return i(n.call(H))}}}return H},_.value=function(){var e=_.group();return e[e.value?"value":"all"]()},_.domain=function(){return D?_.group().all().map(o("key")):null},_.transform=function(t){var n=k(arguments);if(O(t)){if(!e(B,t))throw new Error("The specified reduce funciton alias has not been defined");n.shift()}else{if(!e(B,"_"))throw new Error("An alias must be supplied for the transform to be applied to");t="_"}return n=P(n[0])?n[0]:n,n.forEach(function(e){F.push(function(n){return n[t]=e(n[t]),n})}),_},_.extract=M(function(e){return o(e)}),_.limit=M(w),_.order=_.orderAsc=M(b),_.orderDesc=M(function(e){var t=b(e);return function(e){return L(t(e))}}),_.reverse=M(function(){return function(e){return L(k(e))}}),["ready","change","filter"].forEach(function(e){t.on(e,function(){var t=[e].concat(k(arguments));_.trigger.apply(_,t)})}),t.on("filter",function(e,t){(!D||e!==D)&&_.trigger("change")}),_},N.addDriver("preload",function(e,t){D(t)&&this.fieldMap(t),this.add(P(e)?e:[])}),N.addDriver("lytics",function(e){function t(e,t){var n=e.url||"//api.lytics.io",r=n+"/api/"+(e.clientId?e.clientId+"/":"")+e.query,i=e.data||{},s=[];return Object.keys(i).forEach(function(e){s.push(e+"="+i[e])}),s.length&&(r+="?"+s.join("&")),r}function n(e){e.meta&&e.data&&i(e.data,r(e.meta))}function r(e){var t=e.dimensions,n=e.measures,r={},i={},u=1;return t&&t.length>0?(t.forEach(function(e,t){i[e]=t}),u=t.length):i._=0,n.forEach(function(e,t){i[e.As]=t+u,e.Op==="top"&&(r[t+u]=s)}),i._ts=u+n.length,i._date=i._ts+1,o.fieldMap(i),r}function i(e,t){var n=[];e.forEach(function(e){var r=e._ts,i=new Date(r.ts*1e3);e.rows.forEach(function(e,s){Object.keys(t).forEach(function(n){e[n]=t[n](e[n])}),e.push(r.ts),e.push(i),n.push(e)})}),o.add(n)}function s(e){return Array.isArray(e)?e.map(function(e){return key=Object.keys(e)[0],{key:key,value:e[key]}}):e}var o=this;return e=e||{},function(r){var i=document.createElement("script"),s="analyst_lytics_"+(new Date).getTime();e.data=e.data||{},e.data.callback=s,S[s]=function(e){n(e),delete S[s],i.remove()},i.src=t(e,r),document.body.appendChild(i)}}),typeof exports!="undefined"?exports.analyst=N:typeof define=="function"&&define.amd?define("analyst",function(){return N}):S.analyst=N})();